---
title: "Custom protocol bruh?"
slug: "custom-protocol-bruh"
date: "2025-04-15"
excerpt: "Creating a custom protocol decoder for the Salea logic analyzer."
tags: ["saleae", "firmware"]
author: "Riley Porter"
coverImage: "./images/cover.png"
---
## Creating a custom protocol decoder for the Salea logic analyzer.

## Introduction

LoRa (Long Range) technology is often paired with LoRaWAN, but LoRa itself is simply a radio modulation technique. LoRaWAN adds network management, security layers, and other protocol overhead. For many embedded applications, especially those requiring minimal latency, low power, and straightforward point-to-point (P2P) communication, direct LoRa programming is preferable.

This guide explores programming the RAK3172 module directly, bypassing LoRaWAN completely.

## Overview: Direct LoRa Programming

Direct LoRa programming allows developers to:

- Send and receive raw LoRa packets.
- Precisely manage radio states and transitions.
- Achieve deterministic timing and low latency.
- Minimize firmware complexity and reduce power consumption.

## RAK3172 Module

The RAK3172 integrates an STM32WLE5 microcontroller with an SX1262 radio chip, providing a compact and highly capable platform for custom LoRa solutions.

### Erasing Default Firmware

Before loading custom firmware, erase the default AT-command-based firmware to free up memory and remove unnecessary functionalities.

### Firmware Development with STM32CubeMX

Use STM32CubeMX to configure the firmware:

- **Disable unused peripherals** to conserve resources.
- Enable only the required interfaces, typically:
  - UART for command-line interactions and debugging.
  - GPIO for sensor interfacing and control signals.
  - RTC for scheduled wake-ups and precise timing.
- Activate the SX1262 radio driver for direct radio control.

A detailed setup guide is available on [STM32World's RAK3172 page](https://stm32world.com/wiki/RAK3172#Setting_up_the_IOC_file).

## Direct LoRa Radio Usage

Direct control of the SX1262 radio enables straightforward, clear, and efficient communication:

```c
// Set radio transmission parameters
Radio.SetTxConfig(MODEM_LORA, power, bandwidth, datarate, codingRate,
                  preambleLength, fixLen, crcOn, freqHopOn, hopPeriod,
                  iqInverted, timeout);

// Send data buffer via LoRa
Radio.Send(buffer, length);
```

No middleware or network stacks are required, simplifying development and debugging significantly.

## Advantages of Direct LoRa Programming

- **Efficiency**: Lower power consumption and longer battery life.
- **Smaller Firmware Size**: Essential for memory-constrained embedded systems.
- **Simpler Debugging**: Clear packet-level visibility simplifies troubleshooting.
- **Customization**: Complete control over radio settings, including:
  - Frequency
  - Bandwidth
  - Spreading factor
  - Transmission power

## Application Examples

Direct LoRa is suitable for:

- Remote sensors with critical power requirements.
- Simple telemetry systems.
- Local area communication without internet dependency.
- Custom security implementations with specialized encryption and packet framing.

## Potential Enhancements

Future capabilities achievable with direct LoRa programming:

- **Custom Encryption**: Tailored security measures directly embedded within packets.
- **Advanced Power Management**: Wake-on-radio and selective listening for minimal power draw.
- **OTA Firmware Updates**: Secure and efficient updates transmitted directly via LoRa.

## Future Exploration: LoRa Fuzzing

An intriguing future application of this direct LoRa firmware involves fuzz testing for security and robustness. By using UART communication to interact with the firmware, developers can drive test scenarios from external devices such as a Pico-based tool (e.g., PicoTag). This setup would allow comprehensive testing of LoRa or potentially even LoRaWAN protocols, enabling the discovery of vulnerabilities or unexpected behaviors in radio implementations. Detailed insights into creating such a fuzz-testing system will be explored in an upcoming blog.

## Conclusion

Direct programming of LoRa modules, such as the RAK3172, offers developers a powerful and efficient alternative to LoRaWAN. By directly interfacing with the LoRa radio, developers gain significant advantages in simplicity, power consumption, and system responsiveness, making it ideal for highly optimized embedded solutions.

